import json
import boto3
import os

# ×™×¦×™×¨×ª ×—×™×‘×•×¨ ×œ-DynamoDB
dynamodb = boto3.resource('dynamodb')
table = dynamodb.Table('games')  # ×× ××ª×” ×¨×•×¦×” ×œ×”×©×ª××© ×‘Ö¾ENV, ×©× ×” ×œ: os.environ['DYNAMODB_TABLE']

def lambda_handler(event, context):
    print("ğŸš€ ×”×ª×—×œ×ª ×”×¨×¦×ª Lambda")

    # ×‘×“×™×§×ª ×§×™×•× ×’×•×£ ×”×‘×§×©×”
    if 'body' not in event or event['body'] is None:
        print("âŒ ×—×¡×¨ ×’×•×£ ×”×‘×§×©×” (body)")
        return error_response(400, 'Missing request body')

    try:
        body = json.loads(event['body'])
        print("âœ… JSON ×¤×•×¢× ×—:", body)

        game_id = body.get('game_id')
        players_count = body.get('players_count')

        if not game_id or players_count is None:
            print("âŒ ×—×¡×¨×™× ×¤×¨××˜×¨×™× ×—×•×‘×”: game_id ××• players_count")
            return error_response(400, 'Missing game_id or players_count')

        # ×”××¨×” ×œ××¡×¤×¨ ×©×œ×
        players_count = int(players_count)
        print(f"âœ… ×¢×“×›×•×Ÿ ×”××©×—×§ {game_id} ×¢× players_count = {players_count}")

        # ×¢×“×›×•×Ÿ ×‘×˜×‘×œ×”
        response = table.update_item(
            Key={'game_id': game_id},
            UpdateExpression='SET players_count = :pc',
            ExpressionAttributeValues={':pc': players_count}
        )

        print("âœ… ×¢×“×›×•×Ÿ ×‘×•×¦×¢ ×‘×”×¦×œ×—×”:", response)

        return {
            'statusCode': 200,
            'body': json.dumps({'message': 'players_count updated successfully'}),
            'headers': cors_headers()
        }

    except Exception as e:
        print("âŒ ×©×’×™××” ×›×œ×œ×™×ª:", str(e))
        return error_response(500, 'Internal Server Error')


def cors_headers():
    return {
        'Access-Control-Allow-Origin': '*',
        'Access-Control-Allow-Headers': '*',
        'Access-Control-Allow-Methods': 'OPTIONS,POST'
    }

def error_response(status_code, message):
    return {
        'statusCode': status_code,
        'body': json.dumps({'error': message}),
        'headers': cors_headers()
    }
